apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: tautulli
  namespace: default
spec:
  driftDetection:
    mode: enabled
  interval: 15m
  chart:
    spec:
      # renovate: registryUrl=https://bjw-s-labs.github.io/helm-charts
      chart: app-template
      version: 4.6.2
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: flux-system
  maxHistory: 3
  install:
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  uninstall:
    keepHistory: false
  values:
    controllers:
      main:
        defaultContainerOptions:
          resources:
            requests:
              cpu: 10m
              memory: 250Mi
            limits:
              memory: 2Gi
        annotations:
          reloader.stakater.com/auto: "true"
        pod:
          securityContext:
            fsGroup: 3001
            fsGroupChangePolicy: "OnRootMismatch"
            supplementalGroups: [ 568, 911, 1000, 1001 ]
          tolerations:
          - key: "arm"
            operator: "Exists"
        containers:
          main:
            image:
              # renovate: repository=ghcr.io/tautulli/tautulli
              repository: ghcr.io/tautulli/tautulli
              tag: v2.16.1
            securityContext:
              runAsUser: 0
              runAsGroup: 0
            env:
              TZ: America/New_York
              PUID: 1000
              PGID: 3001
    service:
      main:
        # annotations:
        # traefik.ingress.kubernetes.io/service.nativelb: "true"
        controller: main
        ports:
          http:
            port: 8181
    ingress:
      main:
        annotations:
          kubernetes.io/ingress.class: traefik
          traefik.ingress.kubernetes.io/router.entrypoints: web,websecure
          traefik.ingress.kubernetes.io/router.middlewares: "network-system-authentik@kubernetescrd"
          gethomepage.dev/enabled: "true"
          gethomepage.dev/group: Development
          gethomepage.dev/icon: tautulli.svg
          gethomepage.dev/name: Tautulli
          gethomepage.dev/description: Tautulli is a Python-based web application that provides monitoring and analytics for Plex Media Server. It allows users to track their Plex server's activity, view detailed statistics about media consumption, and receive notifications about server events. Tautulli offers features such as real-time monitoring, historical data analysis, and customizable alerts, making it a valuable tool for Plex users who want to keep an eye on their media server's performance and usage.
        className: 'traefik'
        hosts:
        - host: &host "tautulli.homelab.heyser.xyz"
          paths:
          - path: /
            pathType: Prefix
            service:
              identifier: main
              port: http
        tls:
        - hosts:
          - *host
          secretName: tautulli-homelab-heyser-xyz-tls
    persistence:
      config:
        existingClaim: tautulli-config
        advancedMounts:
          main:
            main:
            - path: "/config"
